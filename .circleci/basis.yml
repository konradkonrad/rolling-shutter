version: 2.1

commands:
  install-go:
    steps:
      - run:
          name: Install go
          command: |
            curl -sSL "https://go.dev/dl/go1.18rc1.linux-amd64.tar.gz" | sudo tar -xz -C /usr/local/
            mkdir -p ~/go/bin
            echo >${BASH_ENV} 'export PATH=/usr/local/go/bin:~/go/bin:${PATH}'

  install-asdf:
    steps:
      - run:
          name: Install asdf
          command: |
            if [[ -e ~/.asdf ]]; then
              echo "asdf already installed"
            else
              git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.9.0
            fi
            echo >${BASH_ENV} 'source ~/.asdf/asdf.sh'

orbs:
  node: circleci/node@4.7

executors:
  system-tests:
    docker:
      - image: cimg/openjdk:17.0.2-node
        environment:
          PGHOST: localhost
          PGUSER: circleci
          PLAY_DB_PASSWORD: xxx

      - image: circleci/postgres:12
        environment:
          POSTGRES_USER: circleci
          POSTGRES_PASSWORD: xxx
          POSTGRES_DB: testdb
  py:
    docker:
      - image: cimg/python:3.9.7-node@sha256:f014580897eea0a92ef30b79aefd2fd58c09853e4d1bcd1e0578a9c67681d183
        environment:
          PIP_DISABLE_PIP_VERSION_CHECK: "1"
  node14:
    docker:
      - image: cimg/node:14.17.4

  go:
    docker:
      - image: cimg/go:1.17.5@sha256:03bc021893b54e1f7c981dc3a391df868a01e24899044d382f068d2014b80348
        environment:
          GO111MODULE: "on"
          PIP_DISABLE_PIP_VERSION_CHECK: "1"
  go-integration:
    docker:
      - image: cimg/go:1.17.5@sha256:03bc021893b54e1f7c981dc3a391df868a01e24899044d382f068d2014b80348
        environment:
          GO111MODULE: "on"
          PIP_DISABLE_PIP_VERSION_CHECK: "1"
          ROLLING_SHUTTER_TESTDB_URL: postgres://pguser:password@localhost:5432/testdb
      - image: circleci/postgres:12
        environment:
          POSTGRES_USER: pguser
          POSTGRES_PASSWORD: password
          POSTGRES_DB: testdb
  go116:
    docker:
      - image: cimg/go:1.16.12@sha256:810440a9128875dcf397e7c23e487977159d9e6d98b58b24183dffabdee30ee6
        environment:
          GO111MODULE: "on"
          PIP_DISABLE_PIP_VERSION_CHECK: "1"

jobs:
  pre-commit:
    executor: py
    working_directory: ~/src
    steps:
      - checkout
      - run:
          name: Configure nodeenv
          command: |
            cp .circleci/.nodeenvrc ~
      - install-go
      - restore_cache:
          keys:
            - go-mod-v3-{{ checksum "rolling-shutter/go.sum" }}-{{ checksum "rolling-shutter/go.mod" }}
      - restore_cache:
          key: pre-commit-cache-v7-{{ checksum ".pre-commit-config.yaml" }}
      - run:
          name: Install pre-commit
          command: |
            if [[ -e ~/.local/bin/pre-commit ]]; then
              echo "pre-commit already installed"
            else
              pip install --user https://github.com/pre-commit/pre-commit/archive/379db4cb880b30b05863035d2d29a1f66b5795d9.zip
            fi
      - run: pre-commit install-hooks
      - save_cache:
          key: pre-commit-cache-v7-{{ checksum ".pre-commit-config.yaml" }}
          paths:
            - ~/.cache/pre-commit
            - ~/.local
      - run: pre-commit run --show-diff-on-failure -a

workflows:
  version: 2
  pre-commit:
    jobs:
      - pre-commit
